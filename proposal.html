<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFx Creation Portal | Accel Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1E3A8A;      /* Deep Navy Blue */
            --secondary: #0F9D58;    /* Accel Green */
            --accent: #34C759;       /* Bright Green */
            --light: #F8FAFC;        /* Light Background */
            --dark: #1A202C;         /* Dark Text */
            --gray: #A0AEC0;         /* Medium Gray */
            --border: #E2E8F0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        /* Header & Hero */
        .hero-header {
            background: linear-gradient(rgba(30, 58, 138, 0.9), rgba(30, 58, 138, 0.95)), url('https://img1.wsimg.com/isteam/ip/0815fdc9-aafc-4fe1-99f8-dedc9ba0e23b/blob-02576cc.png/:/rs=w:1440,h:1440');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 120px 20px 60px;
            text-align: center;
            position: relative;
        }

        .logo-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
        }

        .logo {
            height: 60px;
            filter: brightness(0) invert(1);
        }

        .hero-title {
            font-size: 2.8rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .hero-subtitle {
            font-size: 1.3rem;
            font-weight: 500;
            opacity: 0.95;
            max-width: 800px;
            margin: 0 auto;
        }

        /* Persistent Banner */
        .persistent-banner {
            background-color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 99;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-bottom: 1px solid var(--border);
        }

        .banner-left {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--primary);
        }

        .global-weight {
            font-weight: 700;
            color: var(--secondary);
        }

        .validation {
            color: #E53E3E;
            font-size: 0.9rem;
            margin-left: 8px;
        }

        .banner-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0d8548;
            transform: translateY(-1px);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-danger {
            background-color: #E53E3E;
            color: white;
        }

        .btn-danger:hover {
            background-color: #C53030;
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* Section Styling */
        .section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }

        .section h2 {
            color: var(--primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E6F0FF;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section h2 .add-btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .section h2 .add-btn:hover {
            background-color: #0d8548;
        }

        /* Form Styling */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px 14px;
            border: 1.5px solid #CBD5E0;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(15, 157, 88, 0.15);
        }

        .form-group input[readonly],
        .form-group textarea[readonly],
        .form-group select[disabled] {
            background-color: #F7FAFC;
            color: #4A5568;
            cursor: not-allowed;
        }

        /* Table Styling */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 0.95rem;
        }

        th {
            background-color: #EBF4FF;
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 14px 12px;
            border-bottom: 2px solid var(--primary);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #E2E8F0;
            vertical-align: top;
        }

        tr:hover td {
            background-color: #F8FAFC;
        }

        td input, td textarea, td select {
            width: 100%;
            padding: 8px 10px;
            border: 1.5px solid #CBD5E0;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        td input[type="number"] {
            width: 80px;
        }

        td textarea {
            min-height: 60px;
            resize: vertical;
        }

        .action-btn {
            background: none;
            border: none;
            color: #E53E3E;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: 0.2s;
        }

        .action-btn:hover {
            background-color: #FFF5F5;
            color: #C53030;
        }

        /* Modal */
        #cancelModal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 200;
            width: 500px;
            max-width: 90vw;
        }

        #cancelModal h3 {
            color: var(--primary);
            margin-bottom: 16px;
        }

        #cancelModal textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1.5px solid #CBD5E0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: 'Roboto', sans-serif;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.2rem;
            }
            .hero-subtitle {
                font-size: 1.1rem;
            }
            .persistent-banner {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            .banner-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>

    <!-- Hero Header -->
    <header class="hero-header">
        <div class="logo-container">
            <img src="https://img1.wsimg.com/isteam/ip/0815fdc9-aafc-4fe1-99f8-dedc9ba0e23b/blob-f3ca1db.png/:/rs=w:331,h:400,cg:true,m/cr=w:331,h:400/qt=q:95" alt="Accel Analysis Logo" class="logo">
        </div>
        <h1 class="hero-title">RFx Creation Portal</h1>
        <p class="hero-subtitle">Create and publish Requests for Information or Proposals with full evaluation criteria</p>
    </header>

    <!-- Persistent Banner -->
    <div class="persistent-banner">
        <div class="banner-left">
            <span>Global Total Weight: <span id="globalWeight" class="global-weight">0%</span></span>
            <span class="validation" id="globalWeightValidation">Total weight must sum to 100%</span>
        </div>
        <div class="banner-actions">
  <button class="btn btn-outline" onclick="alert('Saved')">Save</button>
  <button class="btn btn-outline" onclick="alert('Saved & Closed')">Save & Close</button>
  <button class="btn btn-outline" onclick="alert('Closed')">Close without Saving</button>
  <button class="btn btn-primary" onclick="alert('Published')">Publish</button>
  <button class="btn btn-danger" id="cancelBtn" onclick="showCancelModal()">Cancel RFx</button>
</div>
    </div>
    <input type="hidden" id="propertyPayload" value='[{"id":"123","lat":..., "lng":...}]'>
    <!-- Main Container -->
    <div class="main-container">

        <!-- RFx General Info -->
        <div class="section">
            <h2>RFx General Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Business Process Code</label>
                    <input type="text" id="bpCode" placeholder="e.g., BPN123456">
                </div>
                <div class="form-group">
                    <label>RFx Title *</label>
                    <input type="text" id="label" placeholder="Enter descriptive title" required>
                </div>
                <div class="form-group">
                    <label>Lot #</label>
                    <input type="text" id="lot" readonly value="1">
                </div>
                <div class="form-group">
                    <label>Round</label>
                    <input type="text" id="round" readonly value="0">
                </div>
                <div class="form-group">
                    <label>Issued Date/Time (UTC-5)</label>
                    <input type="datetime-local" id="issuedDate" readonly>
                </div>
                <div class="form-group">
                    <label>Close Date/Time (UTC-5) *</label>
                    <input type="datetime-local" id="closeDate" required>
                </div>
                <div class="form-group">
                    <label>Opportunity Type *</label>
                    <select id="oppType" onchange="toggleCostSection()">
                        <option>Request for Information (RFI)</option>
                        <option>Request for Proposal (RFP)</option>
                        <option>Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Set Aside</label>
                    <input type="text" id="setAside" placeholder="e.g., Small Business">
                </div>
            </div>
            <div class="form-group" style="grid-column: span 2;">
                <label>Summary *</label>
                <textarea id="summary" rows="4" placeholder="Provide a detailed project overview..." required></textarea>
            </div>
            <div class="form-group">
                <label>Website</label>
                <input type="url" id="website" placeholder="https://example.com">
            </div>
            <div class="form-group">
                <label>Process</label>
                <select id="process">
                    <option>Electronic</option>
                    <option>Paper Responses Only</option>
                </select>
            </div>
        </div>

        <!-- RFx Documents -->
        <div class="section">
            <h2>RFx Documents</h2>
            <button class="add-btn" onclick="addDocRow()">+ Add Document</button>
            <table id="docsTable">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>File</th>
                        <th>Contact</th>
                        <th>Last Modified</th>
                        <th>Created</th>
                        <th>Validity End</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="docCount" style="margin-top: 12px; color: var(--gray);">0 documents</p>
        </div>

        <!-- Skills -->
        <div class="section">
            <h2>Requested Skills</h2>
            <button class="add-btn" onclick="addSkillRow()">+ Add Skill</button>
            <table id="skillsTable">
                <thead>
                    <tr><th>Label</th><th>Level</th><th>Required</th><th>Criteria Weight (%)</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="skillCount" style="margin-top: 12px; color: var(--gray);">0 skills</p>
        </div>

        <!-- Experience/Past Performance -->
        <div class="section">
            <h2>Requested Experience/Past Performance</h2>
            <button class="add-btn" onclick="addExperienceRow()">+ Add Requirement</button>
            <table id="experienceTable">
                <thead>
                    <tr><th>Name</th><th>Description</th><th>Years</th><th>Required</th><th>Criteria Weight (%)</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="expCount" style="margin-top: 12px; color: var(--gray);">0 items</p>
        </div>

        <!-- Certifications/Credentials -->
        <div class="section">
            <h2>Requested Certifications/Credentials</h2>
            <button class="add-btn" onclick="addCertRow()">+ Add Certification</button>
            <table id="certTable">
                <thead>
                    <tr><th>Name</th><th>Body</th><th>Min. Exp. Date</th><th>Doc</th><th>Required</th><th>Criteria Weight (%)</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="certCount" style="margin-top: 12px; color: var(--gray);">0 items</p>
        </div>

        <!-- References -->
        <div class="section">
            <h2>Requested References</h2>
            <button class="add-btn" onclick="addRefRow()">+ Add Reference</button>
            <table id="refTable">
                <thead>
                    <tr><th>Type</th><th>Required</th><th>Criteria Weight (%)</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="refCount" style="margin-top: 12px; color: var(--gray);">0 items</p>
        </div>

        <!-- Custom RFx Criteria -->
        <div class="section">
            <h2>Custom RFx Criteria</h2>
            <button class="add-btn" onclick="addCriterionRow()">+ Add Criterion</button>
            <table id="criteriaTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Criterion</th>
                        <th>Description</th>
                        <th>Weight (%)</th>
                        <th>Max Points</th>
                        <th>Method</th>
                        <th>Required</th>
                        <th>Doc</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Cost/Financial Proposal (RFP only) -->
        <div class="section" id="costSection" style="display: none;">
            <h2>Cost/Financial Proposal</h2>
            <button class="add-btn" onclick="addCostRow()">+ Add Cost Item</button>
            <table id="costTable">
                <thead>
                    <tr><th>Item</th><th>Amount</th><th>Breakdown</th><th>Required</th><th>Criteria Weight (%)</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
            </table>
            <p id="costCount" style="margin-top: 12px; color: var(--gray);">0 items</p>
        </div>

    </div>

    <!-- Cancel Modal -->
    <div id="cancelModal">
        <h3>Cancel RFx</h3>
        <label>Reason for Cancellation *</label>
        <textarea id="cancelReason" placeholder="Provide detailed reason for cancellation..."></textarea>
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="hideCancelModal()">Close</button>
            <button class="btn btn-danger" onclick="submitCancel()">Submit Cancellation</button>
        </div>
    </div>

    <script>
        // Load current data
        window.onload = function() {
            const now = new Date();
            const utc5Offset = now.getTimezoneOffset() + 300;
            const utc5Date = new Date(now.getTime() - utc5Offset * 60000);
            document.getElementById('issuedDate').value = utc5Date.toISOString().slice(0, 16);

            const isPublished = true;
            document.getElementById('cancelBtn').style.display = isPublished ? 'inline-block' : 'none';

            toggleCostSection();
        };

        function toggleCostSection() {
            const oppType = document.getElementById('oppType').value;
            document.getElementById('costSection').style.display = (oppType === 'Request for Proposal (RFP)') ? 'block' : 'none';
            updateTotals();
        }

        // Documents
        let docCounter = 0;
        function addDocRow() {
            const tbody = document.querySelector('#docsTable tbody');
            const row = tbody.insertRow();
            const now = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });

            row.innerHTML = `
                <td><input type="text" value="Scope of Work.pdf"></td>
                <td>RFx Document (Approved)</td>
                <td><input type="file"></td>
                <td>Current User</td>
                <td>${now}</td>
                <td>${now}</td>
                <td><input type="date"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateDocCount()">Remove</button></td>
            `;
            docCounter++;
            updateDocCount();
        }
        function updateDocCount() {
            docCounter = document.querySelectorAll('#docsTable tbody tr').length;
            document.getElementById('docCount').innerText = `${docCounter} document${docCounter !== 1 ? 's' : ''}`;
        }

        // Skills
        let skillCounter = 0;
        function addSkillRow() {
            const tbody = document.querySelector('#skillsTable tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="Housing Market Analysis"></td>
                <td>
                    <select>
                        <option>Expert</option>
                        <option>Intermediate</option>
                        <option>Beginner</option>
                    </select>
                </td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateSkillCount(); updateTotals()">Remove</button></td>
            `;
            skillCounter++;
            updateSkillCount();
            updateTotals();
        }
        function updateSkillCount() {
            skillCounter = document.querySelectorAll('#skillsTable tbody tr').length;
            document.getElementById('skillCount').innerText = `${skillCounter} skill${skillCounter !== 1 ? 's' : ''}`;
        }

        // Experience
        let expCounter = 0;
        function addExperienceRow() {
            const tbody = document.querySelector('#experienceTable tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="Regional Housing Study"></td>
                <td><textarea rows="2">Minimum 3 years experience...</textarea></td>
                <td><input type="number" min="0" value="3"></td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateExpCount(); updateTotals()">Remove</button></td>
            `;
            expCounter++;
            updateExpCount();
            updateTotals();
        }
        function updateExpCount() {
            expCounter = document.querySelectorAll('#experienceTable tbody tr').length;
            document.getElementById('expCount').innerText = `${expCounter} item${expCounter !== 1 ? 's' : ''}`;
        }

        // Certifications
        let certCounter = 0;
        function addCertRow() {
            const tbody = document.querySelector('#certTable tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="AICP Certification"></td>
                <td><input type="text" value="American Planning Association"></td>
                <td><input type="date"></td>
                <td><input type="file"></td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateCertCount(); updateTotals()">Remove</button></td>
            `;
            certCounter++;
            updateCertCount();
            updateTotals();
        }
        function updateCertCount() {
            certCounter = document.querySelectorAll('#certTable tbody tr').length;
            document.getElementById('certCount').innerText = `${certCounter} item${certCounter !== 1 ? 's' : ''}`;
        }

        // References
        let refCounter = 0;
        function addRefRow() {
            const tbody = document.querySelector('#refTable tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>
                    <select>
                        <option>Business Reference</option>
                        <option>Personal Reference</option>
                    </select>
                </td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateRefCount(); updateTotals()">Remove</button></td>
            `;
            refCounter++;
            updateRefCount();
            updateTotals();
        }
        function updateRefCount() {
            refCounter = document.querySelectorAll('#refTable tbody tr').length;
            document.getElementById('refCount').innerText = `${refCounter} item${refCounter !== 1 ? 's' : ''}`;
        }

        // Custom Criteria
        let criteriaCounter = 0;
        function addCriterionRow() {
            const tbody = document.querySelector('#criteriaTable tbody');
            const row = tbody.insertRow();
            criteriaCounter++;
            row.innerHTML = `
                <td>${criteriaCounter}</td>
                <td><input type="text" value="Technical Approach"></td>
                <td><textarea rows="2">Describe methodology, tools, and timeline...</textarea></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td>0</td>
                <td>
                    <select oninput="updateTotals()">
                        <option>Qualitative Narrative</option>
                        <option>Scored Rubric (1-5)</option>
                        <option>Pass/Fail</option>
                        <option>Cost</option>
                    </select>
                </td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="file"></td>
                <td><button class="action-btn" onclick="removeCriterionRow(this)">Remove</button></td>
            `;
            updateTotals();
        }
        function removeCriterionRow(btn) {
            btn.closest('tr').remove();
            criteriaCounter--;
            const rows = document.querySelectorAll('#criteriaTable tbody tr');
            rows.forEach((row, i) => row.cells[0].innerText = i + 1);
            updateTotals();
        }

        // Cost
        let costCounter = 0;
        function addCostRow() {
            const tbody = document.querySelector('#costTable tbody');
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" value="Hourly Rate"></td>
                <td><input type="number" value="0"></td>
                <td><textarea rows="2">Maximum allowable rate...</textarea></td>
                <td><input type="checkbox" checked onchange="updateTotals()"></td>
                <td><input type="number" min="0" max="100" step="0.5" value="0" oninput="updateTotals()"></td>
                <td><button class="action-btn" onclick="this.closest('tr').remove(); updateCostCount(); updateTotals()">Remove</button></td>
            `;
            costCounter++;
            updateCostCount();
            updateTotals();
        }
        function updateCostCount() {
            costCounter = document.querySelectorAll('#costTable tbody tr').length;
            document.getElementById('costCount').innerText = `${costCounter} item${costCounter !== 1 ? 's' : ''}`;
        }

        // Global Weight Calculation
        function updateTotals() {
            const tables = ['skillsTable', 'experienceTable', 'certTable', 'refTable', 'criteriaTable', 'costTable'];
            let total = 0;

            tables.forEach(id => {
                const table = document.getElementById(id);
                if (table && (id !== 'costTable' || document.getElementById('costSection').style.display !== 'none')) {
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        let weightIdx;
                        if (id === 'criteriaTable') weightIdx = 3;
                        else if (id === 'refTable') weightIdx = 2;
                        else weightIdx = row.cells.length - 3;
                        const input = row.cells[weightIdx].querySelector('input[type="number"]');
                        if (input) total += parseFloat(input.value) || 0;

                        if (id === 'criteriaTable') {
                            const weight = parseFloat(input.value) || 0;
                            row.cells[4].innerText = weight * 10;
                        }
                    });
                }
            });

            document.getElementById('globalWeight').innerText = total.toFixed(1) + '%';
            const valid = Math.abs(total - 100) < 0.1;
            document.getElementById('globalWeightValidation').style.display = valid ? 'none' : 'inline';
        }

        // Cancel Modal
        function showCancelModal() {
            document.getElementById('cancelModal').style.display = 'block';
        }
        function hideCancelModal() {
            document.getElementById('cancelModal').style.display = 'none';
        }
        function submitCancel() {
            const reason = document.getElementById('cancelReason').value.trim();
            if (reason) {
                alert('RFx Canceled: ' + reason);
                hideCancelModal();
            } else {
                alert('Please provide a reason for cancellation.');
            }
        }
    </script>
<script>
// --- lightweight fetch helper ---
async function api(route, method='GET', body=null, qs={}) {
  const u = new URL(CONFIG.APPSCRIPT_BASE);
  u.searchParams.set('route', route);
  Object.entries(qs).forEach(([k,v]) => u.searchParams.set(k, v));
  const res = await fetch(u.toString(), {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : null,
    mode: 'cors',
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

// --- utilities ---
function val(id) { const el = document.getElementById(id); return el ? el.value : ''; }
function bool(el) { return !!(el && (el.checked || el.value === 'true')); }
function parseNum(v) { const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }

function serializeTableRows(tableId, mapFn) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  if (!tbody) return [];
  return Array.from(tbody.querySelectorAll('tr')).map(row => mapFn(row));
}

// turn criteria table rows into objects with stable keys
function getCriteriaFromProposal() {
  return serializeTableRows('criteriaTable', row => ({
    number: row.cells[0]?.textContent?.trim() || '',
    criterion: row.cells[1]?.querySelector('input')?.value || '',
    description: row.cells[2]?.querySelector('textarea')?.value || '',
    weightPct: parseNum(row.cells[3]?.querySelector('input')?.value),
    maxPoints: parseNum(row.cells[4]?.textContent || '0'),
    method: row.cells[5]?.querySelector('select')?.value || '',
    required: row.cells[6]?.querySelector('input[type="checkbox"]')?.checked || false,
    requiresDoc: !!row.cells[7]?.querySelector('input[type="file"]')
  }));
}

function getSkillsFromProposal() {
  return serializeTableRows('skillsTable', row => ({
    label: row.cells[0]?.querySelector('input')?.value || '',
    level: row.cells[1]?.querySelector('select')?.value || '',
    required: row.cells[2]?.querySelector('input[type="checkbox"]')?.checked || false,
    weightPct: parseNum(row.cells[3]?.querySelector('input')?.value)
  }));
}

function getExperienceFromProposal() {
  return serializeTableRows('experienceTable', row => ({
    name: row.cells[0]?.querySelector('input')?.value || '',
    description: row.cells[1]?.querySelector('textarea')?.value || '',
    years: row.cells[2]?.querySelector('input')?.value || '',
    required: row.cells[3]?.querySelector('input[type="checkbox"]')?.checked || false,
    weightPct: parseNum(row.cells[4]?.querySelector('input')?.value)
  }));
}

function getCertsFromProposal() {
  return serializeTableRows('certTable', row => ({
    name: row.cells[0]?.querySelector('input')?.value || '',
    body: row.cells[1]?.querySelector('input')?.value || '',
    minExpDate: row.cells[2]?.querySelector('input[type="date"]')?.value || '',
    required: row.cells[4]?.querySelector('input[type="checkbox"]')?.checked || false,
    weightPct: parseNum(row.cells[5]?.querySelector('input')?.value)
  }));
}

function getRefsFromProposal() {
  return serializeTableRows('refTable', row => ({
    type: row.cells[0]?.querySelector('select')?.value || '',
    required: row.cells[1]?.querySelector('input[type="checkbox"]')?.checked || false,
    weightPct: parseNum(row.cells[2]?.querySelector('input')?.value)
  }));
}

function getCostsFromProposal() {
  const section = document.getElementById('costSection');
  if (!section || section.style.display === 'none') return [];
  return serializeTableRows('costTable', row => ({
    item: row.cells[0]?.querySelector('input')?.value || '',
    amount: parseNum(row.cells[1]?.querySelector('input')?.value),
    breakdown: row.cells[2]?.querySelector('textarea')?.value || '',
    required: row.cells[3]?.querySelector('input[type="checkbox"]')?.checked || false,
    weightPct: parseNum(row.cells[4]?.querySelector('input')?.value)
  }));
}

function globalWeightPct() {
  const parts = [
    ...getSkillsFromProposal().map(x=>x.weightPct||0),
    ...getExperienceFromProposal().map(x=>x.weightPct||0),
    ...getCertsFromProposal().map(x=>x.weightPct||0),
    ...getRefsFromProposal().map(x=>x.weightPct||0),
    ...getCriteriaFromProposal().map(x=>x.weightPct||0),
    ...getCostsFromProposal().map(x=>x.weightPct||0),
  ];
  return parts.reduce((a,b)=>a+b,0);
}
</script>
    <script type="module">
/* --- CONFIG (ESM or global) --- */
import cfg from './config.js';
const CONFIG = (window.CONFIG || cfg);

/* --- small helper --- */
async function api(route, method='GET', body=null, qs={}) {
  const u = new URL(CONFIG.WEBAPP_URL);
  u.searchParams.set('route', route);
  Object.entries(qs).forEach(([k,v]) => u.searchParams.set(k, v));
  const res = await fetch(u.toString(), {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: body ? JSON.stringify(body) : null,
    mode: 'cors'
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}
const v   = id => document.getElementById(id)?.value?.trim() ?? '';
const num = s  => { const n = parseFloat(s); return Number.isFinite(n) ? n : 0; };

/* --- table serializers (match your DOM) --- */
function rows(tableId, map) {
  const tb = document.querySelector(`#${tableId} tbody`);
  return tb ? [...tb.querySelectorAll('tr')].map(map) : [];
}
function getCriteria() {
  return rows('criteriaTable', r => ({
    number: r.cells[0]?.textContent.trim() || '',
    criterion: r.cells[1]?.querySelector('input')?.value || '',
    description: r.cells[2]?.querySelector('textarea')?.value || '',
    method: r.cells[5]?.querySelector('select, input, textarea, [value]')?.value || r.cells[5]?.textContent.trim() || '',
    weightPct: num(r.cells[3]?.querySelector('input')?.value || '0'),
    maxPoints: num(r.cells[4]?.textContent || '0'),
    required: !!r.cells[6]?.querySelector('input[type=checkbox]')?.checked
  }));
}
function getSkills() {
  return rows('skillsTable', r => ({
    label: r.cells[0]?.querySelector('input')?.value || '',
    level: r.cells[1]?.querySelector('select')?.value || '',
    required: !!r.cells[2]?.querySelector('input[type=checkbox]')?.checked,
    weightPct: num(r.cells[3]?.querySelector('input')?.value || '0')
  }));
}
function getExperience() {
  return rows('experienceTable', r => ({
    name: r.cells[0]?.querySelector('input')?.value || '',
    description: r.cells[1]?.querySelector('textarea')?.value || '',
    years: r.cells[2]?.querySelector('input')?.value || '',
    required: !!r.cells[3]?.querySelector('input[type=checkbox]')?.checked,
    weightPct: num(r.cells[4]?.querySelector('input')?.value || '0')
  }));
}
function getCerts() {
  return rows('certTable', r => ({
    name: r.cells[0]?.querySelector('input')?.value || '',
    body: r.cells[1]?.querySelector('input')?.value || '',
    minExpDate: r.cells[2]?.querySelector('input[type=date]')?.value || '',
    required: !!r.cells[4]?.querySelector('input[type=checkbox]')?.checked,
    weightPct: num(r.cells[5]?.querySelector('input')?.value || '0')
  }));
}
function getRefs() {
  return rows('refTable', r => ({
    type: r.cells[0]?.querySelector('select')?.value || '',
    required: !!r.cells[1]?.querySelector('input[type=checkbox]')?.checked,
    weightPct: num(r.cells[2]?.querySelector('input')?.value || '0')
  }));
}
function getCosts() {
  const sec = document.getElementById('costSection');
  if (!sec || sec.style.display === 'none') return [];
  return rows('costTable', r => ({
    item: r.cells[0]?.querySelector('input')?.value || '',
    amount: num(r.cells[1]?.querySelector('input')?.value || '0'),
    breakdown: r.cells[2]?.querySelector('textarea')?.value || '',
    required: !!r.cells[3]?.querySelector('input[type=checkbox]')?.checked,
    weightPct: num(r.cells[4]?.querySelector('input')?.value || '0')
  }));
}
function totalWeight() {
  return [
    ...getCriteria().map(x=>x.weightPct||0),
    ...getSkills().map(x=>x.weightPct||0),
    ...getExperience().map(x=>x.weightPct||0),
    ...getCerts().map(x=>x.weightPct||0),
    ...getRefs().map(x=>x.weightPct||0),
    ...getCosts().map(x=>x.weightPct||0),
  ].reduce((a,b)=>a+b,0);
}

/* --- payload builder --- */
function buildRfxPayload(status='Draft') {
  const payload = {
    bpCode: v('bpCode'),
    label:  v('label'),
    lot:    v('lot'),
    round:  v('round'),
    issuedDate: v('issuedDate'),
    closeDate:  v('closeDate'),
    oppType:    document.getElementById('oppType')?.value || 'Request for Information (RFI)',
    setAside:   v('setAside'),
    summary:    v('summary'),
    website:    v('website'),
    process:    v('process'),
    sections: {
      criteria: getCriteria(),
      skills:   getSkills(),
      experience: getExperience(),
      certifications: getCerts(),
      references: getRefs(),
      costs: getCosts()
    },
    meta: {
      actionCost: (CONFIG.CREDITS?.ACTION_COSTS?.CREATE_RFx ?? 10)
    },
    globalWeightPct: totalWeight(),
    status,
    createdAt: new Date().toISOString()
  };

  // Optional hook: if you store property payload in a hidden field
  const prop = document.getElementById('propertyPayload');
  if (prop && prop.value) {
    try { payload.properties = JSON.parse(prop.value); } catch { payload.propertiesRaw = prop.value; }
  }
  if (!payload.bpCode) {
    payload.bpCode = 'BPC-' + Math.random().toString(36).slice(2,8).toUpperCase();
    const el = document.getElementById('bpCode'); if (el) el.value = payload.bpCode;
  }
  return payload;
}

/* --- return url helper --- */
function backToApp(extraQS='') {
  const qsReturn = new URLSearchParams(location.search).get('return');
  const fixed    = CONFIG.RETURN_URL;
  const ref      = document.referrer && !document.referrer.includes('about:') ? document.referrer : '';
  const base = qsReturn || fixed || ref || '/';
  const sep = base.includes('?') ? '&' : '?';
  location.href = extraQS ? (base + sep + extraQS) : base;
}

/* --- bind events --- */
document.getElementById('btnPublish')?.addEventListener('click', async () => {
  const payload = buildRfxPayload('Published');
  // Weight must equal 100% for RFPs
  if (payload.oppType?.includes('Proposal') && Math.abs(payload.globalWeightPct - 100) > 0.1) {
    alert(`Total criteria weight must be 100% (now ${payload.globalWeightPct.toFixed(1)}%).`);
    return;
  }
  await api('createRfx', 'POST', payload);
  backToApp(`bp=${encodeURIComponent(payload.bpCode)}&state=published`);
});

document.getElementById('btnDraftSave')?.addEventListener('click', async () => {
  const payload = buildRfxPayload('Draft');
  await api('saveDraft', 'POST', payload);
  alert('Draft saved.');
});

document.getElementById('btnDraftClose')?.addEventListener('click', async () => {
  const payload = buildRfxPayload('Draft');
  await api('saveDraft', 'POST', payload);
  backToApp(`bp=${encodeURIComponent(payload.bpCode)}&state=saved`);
});

document.getElementById('btnCloseNoSave')?.addEventListener('click', () => backToApp());

document.getElementById('btnCancelRfx')?.addEventListener('click', () => {
  // You already have showCancelModal()/hideCancelModal()/submitCancel()
  showCancelModal();
});

// override your existing submitCancel to actually persist + return
window.submitCancel = async function submitCancel() {
  const reason = document.getElementById('cancelReason')?.value?.trim();
  if (!reason) return alert('Please provide a reason.');
  const payload = buildRfxPayload('Canceled');
  payload.cancelReason = reason;
  await api('cancelRfx', 'POST', payload);
  backToApp(`bp=${encodeURIComponent(payload.bpCode)}&state=canceled`);
};
</script>
</body>
</html>
